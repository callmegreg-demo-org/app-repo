name: Actions Feature Demo

on:
  # Manual trigger with inputs:
  workflow_dispatch:
    inputs:
      required_job_should_pass:
        description: "If false, the required gate job fails intentionally"
        type: boolean
        required: true
        default: true
      sleep_seconds:
        description: "How long each step should sleep"
        type: string
        required: true
        default: "5"
      demo_message:
        description: "Arbitrary message passed across jobs"
        type: string
        required: true
        default: "Hello from workflow_dispatch"

jobs:
  # Job 1
  prep:
    name: Prep (capture inputs -> outputs)
    runs-on: ubuntu-latest
    # Outputs to pass to downstream jobs:
    outputs:
      required_job_should_pass: ${{ steps.export.outputs.required_job_should_pass }}
      sleep_seconds: ${{ steps.export.outputs.sleep_seconds }}
      demo_message: ${{ steps.export.outputs.demo_message }}
    steps:
      - name: Print workflow_dispatch inputs
        shell: bash
        run: |
          echo "required_job_should_pass=${{ inputs.required_job_should_pass }}"
          echo "sleep_seconds=${{ inputs.sleep_seconds }}"
          echo "demo_message=${{ inputs.demo_message }}"

      - name: Export inputs as job outputs
        id: export
        shell: bash
        run: |
          echo "required_job_should_pass=${{ inputs.required_job_should_pass }}" >> "$GITHUB_OUTPUT"
          echo "sleep_seconds=${{ inputs.sleep_seconds }}" >> "$GITHUB_OUTPUT"
          echo "demo_message=${{ inputs.demo_message }}" >> "$GITHUB_OUTPUT"

      - name: Dummy work (sleep)
        run: sleep "${{ inputs.sleep_seconds }}"

  # Job 2
  side_quest:
    name: Side quest (runs in parallel)
    runs-on: ubuntu-latest
    # Depends on prep to get its outputs
    needs: prep
    steps:
      - name: Sleep (parallel with required gate)
        # Use sleep_seconds from prep outputs
        run: sleep "${{ needs.prep.outputs.sleep_seconds }}"

      - name: Echo message from prep outputs
        # Use demo_message from prep outputs
        run: echo "Message from prep -- ${{ needs.prep.outputs.demo_message }}"

  # Job 3
  required_gate:
    name: Required gate (needs prep)
    runs-on: ubuntu-latest
    needs: prep
    outputs:
      gate_status: ${{ steps.gate.outputs.gate_status }}
    steps:
      # Pass or fail this job based on prep output:
      - name: Decide whether to pass/fail
        id: gate
        shell: bash
        run: |
          echo "required_job_should_pass=${{ needs.prep.outputs.required_job_should_pass }}"

          if [[ "${{ needs.prep.outputs.required_job_should_pass }}" != "true" ]]; then
            echo "gate_status=failed" >> "$GITHUB_OUTPUT"
            echo "Failing intentionally because required_job_should_pass=false"
            exit 1
          fi

          echo "gate_status=passed" >> "$GITHUB_OUTPUT"
          echo "Passing gate job"

      - name: Dummy work (sleep)
        run: sleep "${{ needs.prep.outputs.sleep_seconds }}"

  # Job 4 (matrix)
  matrix_work:
    # Skip this job if the PR is a draft:
    if: ${{ !github.event.pull_request.draft }}
    name: Matrix work (py${{ matrix.python }})
    runs-on: ubuntu-latest
    needs:
      - prep
      - required_gate
    # Define a matrix strategy, which creates multiple parallel jobs:
    strategy:
      fail-fast: false
      matrix:
        python: ["3.14", "3.13", "3.12"]
    steps:
      - uses: actions/checkout@v6

      # Install and configure python:
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}

      # Run a python script stored in the repo:
      - name: Run Python script from a file
        shell: bash
        run: |
          python scripts/actions_demo.py \
            --sleep "${{ needs.prep.outputs.sleep_seconds }}" \
            --message "${{ needs.prep.outputs.demo_message }}" \
            --python "${{ matrix.python }}"

      # Run a python script with the built-in python shell:
      - name: Run inline Python script
        shell: python
        run: |
          import os
          print(os.environ['PATH'])

      - name: Dummy work (sleep)
        run: sleep "${{ needs.prep.outputs.sleep_seconds }}"

  # Job 5
  summary:
    # Always run this job, even if prior jobs failed:
    if: ${{ always() }}
    name: Summary (consume outputs)
    runs-on: ubuntu-latest
    needs:
      - prep
      - side_quest
      - required_gate
      - matrix_work
    steps:
      - name: Show upstream results and outputs
        shell: bash
        run: |
          echo "required_gate result: ${{ needs.required_gate.result }}"
          echo "required_gate output gate_status: ${{ needs.required_gate.outputs.gate_status }}"
          echo "demo_message from prep output: ${{ needs.prep.outputs.demo_message }}"
          echo "matrix_work result: ${{ needs.matrix_work.result }}"

      - name: Dummy work (sleep)
        run: sleep "${{ needs.prep.outputs.sleep_seconds }}"
